<!DOCTYPE html>
<html>
<head>
    <title>Parking Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
        }
        .upload-section.dragover {
            border-color: #2196F3;
            background-color: #f0f8ff;
        }
        #fileInput {
            margin: 10px 0;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        .filter-panel {
            flex: 1;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            width: 10px;
            background-color: #f0f8ff;
        }
        .comparison-panel {
            flex: 1;
            width: 10px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8fff8;  }
        .panel-title {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: bold;
        }
        .panel-title.primary {
            color: #2196F3;
        }
        .panel-title.comparison {
            color: #4CAF50;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, auto);
        }
        .filter-group h4 {
            margin: 0;
            font-size: 14px;
            color: #333;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 5px;
        }

        .month-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 5px;
        }
        .radio-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
        }
        .checkbox-item input[type="checkbox"], .radio-item input[type="radio"] {
            transform: scale(1.1);
        }
        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        input[type="checkbox"], input[type="radio"] {
            transform: scale(1.2);
        }
        select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
            width: 150px;
        }
        select:focus {
            outline: none;
            border-color: #2196F3;
        }
        .chart-container {
            position: relative;
            height: 500px;
            margin-top: 20px;
        }
        .combined-stats {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stats-column {
            padding: 10px;
            border-radius: 4px;
        }
        .stats-primary {
            background-color: #e3f2fd;
        }
        .stats-comparison {
            background-color: #e8f5e8;
        }
        .data-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 4px;
            font-size: 14px;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #1976D2;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .navbar {
            background-color: #333;
            overflow: hidden;
            display: flex;
            justify-content: center;
            margin-top: -30px;
            margin-bottom: 10px ;
            margin-left: -30px;
            margin-right: -30px;
        }
        .navbar a {
            color: white;
            padding: 14px 20px;
            text-decoration: none;
            text-align: center;
            display: block;
            transition: background 0.3s;
        }
        .navbar a:hover {
            background-color: #575757;
        }
        .navbar a.active {
            background-color: #04AA6D;
        }
        .content {
            padding: 40px;
            text-align: center;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .export-csv {
            background-color: #4CAF50 !important;
        }
        .export-png {
            background-color: #FF9800 !important;
        }
        .export-csv:hover {
            background-color: #45a049 !important;
        }
        .export-png:hover {
            background-color: #f57c00 !important;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="index.html">Home</a>
        <a href="Bus visualizer 2.0.html">Platforming</a>
        <a href="GO Train maker.html">GO Train Chart</a>
        <a href="Parkingtool.html">Parking Usage Tool</a>
        <a href="Parkingusertool.html">Parking User Search</a>
    </div>
    <div class="container">
        <h1>Parking Analysis Tool</h1>
        <p>Created by Philippe Tremblay / AI</p>
        <div class="upload-section" id="uploadSection">
            <h3>Upload CSV File</h3>
            <p>Expected format: Date, Time, Length (hours), Hotspot #, Lot Name</p>
            <p>Example: 2024-01-15, 09:30, 2.5, 1, LotA</p>
            <input type="file" id="fileInput" accept=".csv" />
            <p><small>Or drag and drop a CSV file here</small></p>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <!-- Primary Dataset Panel -->
            <div class="filter-panel">
                <h3 class="panel-title primary">Primary Dataset</h3>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <h4>Year</h4>
                        <div class="radio-group" id="yearFilters"></div>
                    </div>
                    
                    <div class="filter-group">
                        <h4>Lot</h4>
                        <select id="hotspotFilter" onchange="applyFilters()">
                            <option value="all">All Hotspots</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <h4>Day Type</h4>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="weekdayToggle" checked onchange="toggleWeekdays()">
                                <label for="weekdayToggle">Weekdays</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="weekendToggle" checked onchange="toggleWeekends()">
                                <label for="weekendToggle">Weekends</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <h4>Months</h4>
                        <button onclick="toggleAllMonths()">Toggle All</button>
                        <div class="month-checkboxes" id="monthFilters"></div>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <h4>Days of Week</h4>
                        <button onclick="toggleAllDays()">Toggle All</button>
                        <div class="checkbox-group" id="dayFilters"></div>
                    </div>
                </div>
            </div>

            <!-- Comparison Dataset Panel -->
            <div class="comparison-panel" id="comparisonPanel" style="display: none;">
                <h3 class="panel-title comparison">Comparison Dataset</h3>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <h4>Year</h4>
                        <div class="radio-group" id="comparisonYearFilters"></div>
                    </div>
                    
                    <div class="filter-group">
                        <h4>Compare With</h4>
                        <select id="comparisonHotspotFilter" onchange="applyFilters()">
                            <option value="none">No Comparison</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <h4>Day Type</h4>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="comparisonWeekdayToggle" checked onchange="toggleComparisonWeekdays()">
                                <label for="comparisonWeekdayToggle">Weekdays</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="comparisonWeekendToggle" checked onchange="toggleComparisonWeekends()">
                                <label for="comparisonWeekendToggle">Weekends</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <h4>Months</h4>
                        <button onclick="toggleAllComparisonMonths()">Toggle All</button>
                        <div class="month-checkboxes" id="comparisonMonthFilters"></div>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <h4>Days of Week</h4>
                        <button onclick="toggleAllComparisonDays()">Toggle All</button>
                        <div class="checkbox-group" id="comparisonDayFilters"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-buttons" id="controlButtons" style="display: none;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="estimateTrue" onchange="applyFilters()">
                <label for="estimateTrue">Estimate True Value (x4)</label>
            </div>
            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="exportCSV()" class="export-csv">Export Data (CSV)</button>
            <button onclick="exportPNG()" class="export-png">Export Chart (PNG)</button>
        </div>

        <div class="chart-container" style="display: none;" id="chartContainer">
            <canvas id="parkingChart"></canvas>
        </div>

        <div class="combined-stats" id="combinedStats" style="display: none;">
            <div class="stats-column stats-primary">
                <strong>Primary Dataset Stats:</strong>
                <div id="primaryStats"></div>
            </div>
            <div class="stats-column stats-comparison" id="comparisonStatsColumn" style="display: none;">
                <strong>Comparison Dataset Stats:</strong>
                <div id="comparisonStats"></div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let rawCsvData = [];
        let processedData = [];
        let comparisonProcessedData = [];
        let gaussianParams = null;
        let comparisonGaussianParams = null;
        let availableMonths = [];
        let availableDays = [];
        let availableHotspots = [];
        let availableYears = [];
        let hotspotToNameMap = {};

        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        const dayNames = [
            'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'
        ];

        Chart.register({
            id: 'businessHoursShading',
            beforeDraw(chart, args, options) {
                const {ctx, chartArea: {left, right, top, bottom}, scales: {x}} = chart;

                if (!x || !chart.data.labels.length) return;

                const getXPos = (label) => x.getPixelForValue(label);

                const startBusiness = getXPos("09:00");
                const endBusiness = getXPos("17:00");

                ctx.save();
                ctx.fillStyle = "rgba(100, 100, 100, 0.15)";
                ctx.fillRect(left, top, startBusiness - left, bottom - top);
                ctx.fillRect(endBusiness, top, right - endBusiness, bottom - top);
                ctx.restore();
            }
        });

        function gaussian(x, amplitude, mean, stdDev) {
            const exponent = -0.5 * Math.pow((x - mean) / stdDev, 2);
            return amplitude * Math.exp(exponent);
        }

        function fitGaussian(xData, yData) {
            if (xData.length < 3) return null;

            const maxY = Math.max(...yData);
            const maxIndex = yData.indexOf(maxY);
            const initialMean = xData[maxIndex];
            
            const halfMax = maxY / 2;
            let leftHalf = 0, rightHalf = 0;
            
            for (let i = 0; i < yData.length; i++) {
                if (yData[i] >= halfMax) {
                    leftHalf = xData[i];
                    break;
                }
            }
            
            for (let i = yData.length - 1; i >= 0; i--) {
                if (yData[i] >= halfMax) {
                    rightHalf = xData[i];
                    break;
                }
            }
            
            const initialStdDev = Math.abs(rightHalf - leftHalf) / 2.35;

            let bestParams = {
                amplitude: maxY,
                mean: initialMean,
                stdDev: Math.max(initialStdDev, 30)
            };
            let bestError = Infinity;

            const meanRange = 60;
            const stdDevRange = 60;
            const steps = 15;

            for (let i = 0; i < steps; i++) {
                for (let j = 0; j < steps; j++) {
                    for (let k = 0; k < steps; k++) {
                        const amplitude = maxY * (0.5 + 0.8 * i / steps);
                        const mean = initialMean + (-meanRange + 2 * meanRange * j / steps);
                        const stdDev = Math.max(20, initialStdDev + (-stdDevRange + 2 * stdDevRange * k / steps));

                        let error = 0;
                        for (let idx = 0; idx < xData.length; idx++) {
                            const predicted = gaussian(xData[idx], amplitude, mean, stdDev);
                            const residual = yData[idx] - predicted;
                            error += residual * residual;
                        }

                        if (error < bestError) {
                            bestError = error;
                            bestParams = { amplitude, mean, stdDev };
                        }
                    }
                }
            }

            return bestParams;
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadSection = document.getElementById('uploadSection');

            fileInput.addEventListener('change', handleFile);

            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processFile(files[0]);
                }
            });
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Please select a CSV file.');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('CSV parsing errors: ' + results.errors.map(e => e.message).join(', '));
                        return;
                    }
                    
                    processCsvData(results.data);
                },
                error: function(error) {
                    showError('Error reading file: ' + error.message);
                }
            });
        }

        function processCsvData(data) {
            try {
                const cleanData = data.filter(row => {
                    const keys = Object.keys(row).map(k => k.toLowerCase().trim());
                    return keys.includes('date') && keys.includes('time') && keys.includes('length') && 
                           keys.includes('hotspot #') && keys.includes('lot name');
                }).map(row => {
                    const normalizedRow = {};
                    Object.keys(row).forEach(key => {
                        const cleanKey = key.toLowerCase().trim();
                        normalizedRow[cleanKey] = row[key];
                    });
                    return normalizedRow;
                });

                if (cleanData.length === 0) {
                    showError('No valid data found. Please ensure CSV has columns: Date, Time, Length, Hotspot #, Lot Name');
                    return;
                }

                hotspotToNameMap = {};
                cleanData.forEach(row => {
                    const hotspot = row['hotspot #'] ? row['hotspot #'].toString().trim() : '';
                    const lotName = row['lot name'] ? row['lot name'].toString().trim() : '';
                    if (hotspot && lotName && !hotspotToNameMap[hotspot]) {
                        hotspotToNameMap[hotspot] = lotName;
                    }
                });

                rawCsvData = cleanData.map((row, index) => {
                    try {
                        let dateStr = row.date;
                        if (typeof dateStr === 'number') {
                            dateStr = new Date((dateStr - 25569) * 86400 * 1000).toISOString().split('T')[0];
                        }
                        const date = new Date(dateStr);
                        
                        if (isNaN(date.getTime())) {
                            throw new Error(`Invalid date: ${row.date}`);
                        }

                        let timeStr = row.time;
                        if (typeof timeStr === 'number') {
                            const hours = Math.floor(timeStr);
                            const minutes = Math.round((timeStr - hours) * 60);
                            timeStr = `${hours}:${minutes}`;
                        }
                        
                        timeStr = timeStr.toString().trim();
                        let hours, minutes;
                        
                        if (timeStr.includes(':')) {
                            const timeParts = timeStr.split(':');
                            hours = parseInt(timeParts[0]);
                            minutes = parseInt(timeParts[1]);
                        } else {
                            const timeNum = parseFloat(timeStr);
                            hours = Math.floor(timeNum);
                            minutes = Math.round((timeNum - hours) * 60);
                        }

                        if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                            throw new Error(`Invalid time: ${row.time}`);
                        }

                        let length = row.length;
                        if (typeof length === 'string') {
                            length = parseFloat(length.replace(',', '.'));
                        } else {
                            length = parseFloat(length);
                        }
                        
                        if (isNaN(length) || length <= 0 || length > 24) {
                            throw new Error(`Invalid length: ${row.length} (must be between 0 and 24 hours)`);
                        }

                        const hotspot = row['hotspot #'] ? row['hotspot #'].toString().trim() : '';
                        if (!hotspot) {
                            throw new Error(`Invalid hotspot #: ${row['hotspot #']}`);
                        }

                        return {
                            date: date,
                            hours: hours,
                            minutes: minutes,
                            length: length,
                            dayOfWeek: date.getDay(),
                            month: date.getMonth(),
                            hotspot: hotspot,
                            lotName: hotspotToNameMap[hotspot] || 'Unknown'
                        };
                    } catch (error) {
                        console.warn(`Row ${index + 1}: ${error.message}`);
                        return null;
                    }
                }).filter(row => row !== null);

                if (rawCsvData.length === 0) {
                    showError('No valid parking sessions found after processing.');
                    return;
                }

                availableMonths = [...new Set(rawCsvData.map(row => row.month))].sort((a, b) => a - b);
                availableDays = [...new Set(rawCsvData.map(row => row.dayOfWeek))].sort((a, b) => a - b);
                availableHotspots = [...new Set(rawCsvData.map(row => row.hotspot))].sort();
                availableYears = [...new Set(rawCsvData.map(row => row.date.getFullYear()))].sort();

                setupFilters();
                applyFilters();

                document.getElementById('controls').style.display = 'flex';
                document.getElementById('comparisonPanel').style.display = 'block';
                document.getElementById('controlButtons').style.display = 'flex';
                document.getElementById('chartContainer').style.display = 'block';
                document.getElementById('combinedStats').style.display = 'grid';

            } catch (error) {
                showError('Error processing data: ' + error.message);
            }
        }

        function setupFilters() {
            // Primary year filters
            const yearFiltersDiv = document.getElementById('yearFilters');
            yearFiltersDiv.innerHTML = '';
            availableYears.forEach(year => {
                const div = document.createElement('div');
                div.className = 'radio-item';
                div.innerHTML = `
                    <input type="radio" name="year" id="year${year}" value="${year}" ${year === availableYears[0] ? 'checked' : ''} onchange="applyFilters()">
                    <label for="year${year}">${year}</label>
                `;
                yearFiltersDiv.appendChild(div);
            });

            // Comparison year filters
            const comparisonYearFiltersDiv = document.getElementById('comparisonYearFilters');
            comparisonYearFiltersDiv.innerHTML = '';
            availableYears.forEach(year => {
                const div = document.createElement('div');
                div.className = 'radio-item';
                div.innerHTML = `
                    <input type="radio" name="comparisonYear" id="comparisonYear${year}" value="${year}" ${year === availableYears[0] ? 'checked' : ''} onchange="applyFilters()">
                    <label for="comparisonYear${year}">${year}</label>
                `;
                comparisonYearFiltersDiv.appendChild(div);
            });

            // Primary filters
            const monthFiltersDiv = document.getElementById('monthFilters');
            monthFiltersDiv.innerHTML = '';
            availableMonths.forEach(monthNum => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="month${monthNum}" checked onchange="applyFilters()">
                    <label for="month${monthNum}">${monthNames[monthNum]}</label>
                `;
                monthFiltersDiv.appendChild(div);
            });

            const dayFiltersDiv = document.getElementById('dayFilters');
            dayFiltersDiv.innerHTML = '';
            availableDays.forEach(dayNum => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="day${dayNum}" checked onchange="updateDayTypeCheckboxes(); applyFilters()">
                    <label for="day${dayNum}">${dayNames[dayNum]}</label>
                `;
                dayFiltersDiv.appendChild(div);
            });

            // Comparison filters
            const comparisonMonthFiltersDiv = document.getElementById('comparisonMonthFilters');
            comparisonMonthFiltersDiv.innerHTML = '';
            availableMonths.forEach(monthNum => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="comparisonMonth${monthNum}" checked onchange="applyFilters()">
                    <label for="comparisonMonth${monthNum}">${monthNames[monthNum]}</label>
                `;
                comparisonMonthFiltersDiv.appendChild(div);
            });

            const comparisonDayFiltersDiv = document.getElementById('comparisonDayFilters');
            comparisonDayFiltersDiv.innerHTML = '';
            availableDays.forEach(dayNum => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="comparisonDay${dayNum}" checked onchange="updateComparisonDayTypeCheckboxes(); applyFilters()">
                    <label for="comparisonDay${dayNum}">${dayNames[dayNum]}</label>
                `;
                comparisonDayFiltersDiv.appendChild(div);
            });

            updateDayTypeCheckboxes();
            updateComparisonDayTypeCheckboxes();

            // Hotspot filters
            const hotspotFilterSelect = document.getElementById('hotspotFilter');
            hotspotFilterSelect.innerHTML = '<option value="all">All Lots</option>';
            availableHotspots.forEach(hotspot => {
                const option = document.createElement('option');
                option.value = hotspot;
                option.textContent = `${hotspot} - ${hotspotToNameMap[hotspot] || 'Unknown'}`;
                hotspotFilterSelect.appendChild(option);
            });

            const comparisonHotspotFilterSelect = document.getElementById('comparisonHotspotFilter');
            comparisonHotspotFilterSelect.innerHTML = '<option value="none">No Comparison</option><option value="all">All Lots</option>';
            availableHotspots.forEach(hotspot => {
                const option = document.createElement('option');
                option.value = hotspot;
                option.textContent = `${hotspot} - ${hotspotToNameMap[hotspot] || 'Unknown'}`;
                comparisonHotspotFilterSelect.appendChild(option);
            });
        }

        function toggleAllMonths() {
            const allChecked = availableMonths.every(month => 
                document.getElementById(`month${month}`).checked
            );
            availableMonths.forEach(month => {
                document.getElementById(`month${month}`).checked = !allChecked;
            });
            applyFilters();
        }

        function toggleAllDays() {
            const allChecked = availableDays.every(day => 
                document.getElementById(`day${day}`).checked
            );
            availableDays.forEach(day => {
                document.getElementById(`day${day}`).checked = !allChecked;
            });
            updateDayTypeCheckboxes();
            applyFilters();
        }

        function toggleAllComparisonMonths() {
            const allChecked = availableMonths.every(month => 
                document.getElementById(`comparisonMonth${month}`).checked
            );
            availableMonths.forEach(month => {
                document.getElementById(`comparisonMonth${month}`).checked = !allChecked;
            });
            applyFilters();
        }

        function toggleAllComparisonDays() {
            const allChecked = availableDays.every(day => 
                document.getElementById(`comparisonDay${day}`).checked
            );
            availableDays.forEach(day => {
                document.getElementById(`comparisonDay${day}`).checked = !allChecked;
            });
            updateComparisonDayTypeCheckboxes();
            applyFilters();
        }

        function toggleWeekdays() {
            const weekdayToggle = document.getElementById('weekdayToggle').checked;
            availableDays.forEach(day => {
                if (day >= 1 && day <= 5) {
                    document.getElementById(`day${day}`).checked = weekdayToggle;
                }
            });
            updateDayTypeCheckboxes();
            applyFilters();
        }

        function toggleWeekends() {
            const weekendToggle = document.getElementById('weekendToggle').checked;
            availableDays.forEach(day => {
                if (day === 0 || day === 6) {
                    document.getElementById(`day${day}`).checked = weekendToggle;
                }
            });
            updateDayTypeCheckboxes();
            applyFilters();
        }

        function toggleComparisonWeekdays() {
            const weekdayToggle = document.getElementById('comparisonWeekdayToggle').checked;
            availableDays.forEach(day => {
                if (day >= 1 && day <= 5) {
                    document.getElementById(`comparisonDay${day}`).checked = weekdayToggle;
                }
            });
            updateComparisonDayTypeCheckboxes();
            applyFilters();
        }

        function toggleComparisonWeekends() {
            const weekendToggle = document.getElementById('comparisonWeekendToggle').checked;
            availableDays.forEach(day => {
                if (day === 0 || day === 6) {
                    document.getElementById(`comparisonDay${day}`).checked = weekendToggle;
                }
            });
            updateComparisonDayTypeCheckboxes();
            applyFilters();
        }

        function updateDayTypeCheckboxes() {
            const weekdayChecked = availableDays
                .filter(day => day >= 1 && day <= 5)
                .every(day => document.getElementById(`day${day}`) && document.getElementById(`day${day}`).checked);
            const weekendChecked = availableDays
                .filter(day => day === 0 || day === 6)
                .every(day => document.getElementById(`day${day}`) && document.getElementById(`day${day}`).checked);

            document.getElementById('weekdayToggle').checked = weekdayChecked;
            document.getElementById('weekendToggle').checked = weekendChecked;
        }

        function updateComparisonDayTypeCheckboxes() {
            const weekdayChecked = availableDays
                .filter(day => day >= 1 && day <= 5)
                .every(day => document.getElementById(`comparisonDay${day}`) && document.getElementById(`comparisonDay${day}`).checked);
            const weekendChecked = availableDays
                .filter(day => day === 0 || day === 6)
                .every(day => document.getElementById(`comparisonDay${day}`) && document.getElementById(`comparisonDay${day}`).checked);

            document.getElementById('comparisonWeekdayToggle').checked = weekdayChecked;
            document.getElementById('comparisonWeekendToggle').checked = weekendChecked;
        }

        function applyFilters() {
            // Primary dataset
            const selectedYear = Number(document.querySelector('input[name="year"]:checked').value);
            const selectedMonths = availableMonths.filter(month => 
                document.getElementById(`month${month}`).checked
            );
            const selectedDays = availableDays.filter(day => 
                document.getElementById(`day${day}`).checked
            );
            const selectedHotspot = document.getElementById('hotspotFilter').value;
            const estimateTrue = document.getElementById('estimateTrue').checked;

            const filteredData = rawCsvData.filter(row => {
                const matchesHotspot = selectedHotspot === 'all' || row.hotspot === selectedHotspot;
                const matchesYear = row.date.getFullYear() === selectedYear;
                return selectedMonths.includes(row.month) &&
                       selectedDays.includes(row.dayOfWeek) &&
                       matchesHotspot &&
                       matchesYear;
            });

            if (filteredData.length === 0) {
                showError('No data matches the selected filters.');
                return;
            }

            processedData = processTimeSlots(filteredData, estimateTrue);

            // Comparison dataset
            const comparisonHotspot = document.getElementById('comparisonHotspotFilter').value;
            if (comparisonHotspot !== 'none') {
                const comparisonSelectedYear = Number(document.querySelector('input[name="comparisonYear"]:checked').value);
                const comparisonSelectedMonths = availableMonths.filter(month => 
                    document.getElementById(`comparisonMonth${month}`).checked
                );
                const comparisonSelectedDays = availableDays.filter(day => 
                    document.getElementById(`comparisonDay${day}`).checked
                );

                const comparisonFilteredData = rawCsvData.filter(row => {
                    const matchesHotspot = comparisonHotspot === 'all' || row.hotspot === comparisonHotspot;
                    const matchesYear = row.date.getFullYear() === comparisonSelectedYear;
                    return comparisonSelectedMonths.includes(row.month) &&
                           comparisonSelectedDays.includes(row.dayOfWeek) &&
                           matchesHotspot &&
                           matchesYear;
                });

                if (comparisonFilteredData.length > 0) {
                    comparisonProcessedData = processTimeSlots(comparisonFilteredData, estimateTrue);
                } else {
                    comparisonProcessedData = [];
                }
            } else {
                comparisonProcessedData = [];
            }

            updateChart();
        }

        function processTimeSlots(sessions, estimateTrue) {
            const minuteCounts = new Array(1440).fill(0);

            sessions.forEach(session => {
                const startMinute = session.hours * 60 + session.minutes;
                const endMinute = startMinute + Math.round(session.length * 60);
                
                for (let minute = startMinute; minute < endMinute && minute < 1440; minute++) {
                    if (minute >= 0) {
                        minuteCounts[minute]++;
                    }
                }
            });

            const uniqueDays = new Set(sessions.map(session => 
                session.date.toDateString()
            )).size;

            const result = [];
            for (let minute = 0; minute < 1440; minute += 5) {
                const hours = Math.floor(minute / 60);
                const mins = minute % 60;
                const timeStr = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                
                result.push({
                    time: timeStr,
                    minute: minute,
                    normalizedCount: (minuteCounts[minute] / uniqueDays) * (estimateTrue ? 4 : 1)
                });
            }
            
            return result;
        }

        function updateChart() {
            if (!chart) {
                initChart();
            }

            // Primary dataset
            const businessHoursData = processedData.filter(d => d.minute >= 540 && d.minute <= 1020);
            const xData = businessHoursData.map(d => d.minute);
            const yData = businessHoursData.map(d => d.normalizedCount);
            
            gaussianParams = fitGaussian(xData, yData);

            const gaussianData = processedData.map(d => {
                if (gaussianParams) {
                    return gaussian(d.minute, gaussianParams.amplitude, gaussianParams.mean, gaussianParams.stdDev);
                }
                return null;
            });

            // Comparison dataset
            let comparisonGaussianData = [];
            if (comparisonProcessedData.length > 0) {
                const comparisonBusinessHoursData = comparisonProcessedData.filter(d => d.minute >= 540 && d.minute <= 1020);
                const comparisonXData = comparisonBusinessHoursData.map(d => d.minute);
                const comparisonYData = comparisonBusinessHoursData.map(d => d.normalizedCount);
                
                comparisonGaussianParams = fitGaussian(comparisonXData, comparisonYData);

                comparisonGaussianData = processedData.map(d => {
                    if (comparisonGaussianParams) {
                        return gaussian(d.minute, comparisonGaussianParams.amplitude, comparisonGaussianParams.mean, comparisonGaussianParams.stdDev);
                    }
                    return null;
                });
            } else {
                comparisonGaussianParams = null;
            }

            chart.data.labels = processedData.map(d => d.time);
            chart.data.datasets[0].data = processedData.map(d => d.normalizedCount);
            chart.data.datasets[1].data = gaussianData;
            chart.data.datasets[2].data = comparisonProcessedData.map(d => d.normalizedCount);
            chart.data.datasets[3].data = comparisonGaussianData;

            chart.data.datasets[0].label = document.getElementById('estimateTrue').checked 
                ? 'Primary - Average Cars Parked (x4)'
                : 'Primary - Average Cars Parked';

            chart.data.datasets[2].label = document.getElementById('estimateTrue').checked 
                ? 'Comparison - Average Cars Parked (x4)'
                : 'Comparison - Average Cars Parked';

            const hasComparison = comparisonProcessedData.length > 0;
            chart.data.datasets[2].hidden = !hasComparison;
            chart.data.datasets[3].hidden = !hasComparison;

            document.getElementById('comparisonStatsColumn').style.display = hasComparison ? 'block' : 'none';

            chart.update('none');
            updateStats();
        }

        function updateStats() {
            const primaryStatsDiv = document.getElementById('primaryStats');
            const comparisonStatsDiv = document.getElementById('comparisonStats');
            
            // Primary dataset filters & data
            const selectedYear = Number(document.querySelector('input[name="year"]:checked').value);
            const selectedMonths = availableMonths.filter(month =>
                document.getElementById(`month${month}`) && document.getElementById(`month${month}`).checked
            );
            const selectedDays = availableDays.filter(day => 
                document.getElementById(`day${day}`) && document.getElementById(`day${day}`).checked
            );
            const selectedHotspot = document.getElementById('hotspotFilter').value;

            const filteredData = rawCsvData.filter(row => {
                const matchesHotspot = selectedHotspot === 'all' || row.hotspot === selectedHotspot;
                const matchesYear = row.date.getFullYear() === selectedYear;
                return selectedMonths.includes(row.month) &&
                       selectedDays.includes(row.dayOfWeek) &&
                       matchesHotspot &&
                       matchesYear;
            });

            const totalSessions = filteredData.length;
            const uniqueDays = new Set(filteredData.map(session => session.date.toDateString())).size;
            const hotspotDisplay = selectedHotspot === 'all' 
                ? 'All Lots' 
                : `${selectedHotspot} - ${hotspotToNameMap[selectedHotspot] || 'Unknown'}`;
            const dateRange = getDateRange(filteredData);
            const avgSessionsPerDay = uniqueDays > 0 ? (totalSessions / uniqueDays).toFixed(1) : '0.0';

            if (gaussianParams) {
                const peakHour = Math.floor(gaussianParams.mean / 60);
                const peakMin = Math.round(gaussianParams.mean % 60);
                const peakTimeStr = `${peakHour.toString().padStart(2,'0')}:${peakMin.toString().padStart(2,'0')}`;
                const stdDevHours = (gaussianParams.stdDev / 60).toFixed(1);
                const rSquared = calculateRSquared().toFixed(3);

                primaryStatsDiv.innerHTML = `
Primary Dataset:<br>
Year: ${selectedYear}<br>
Total Sessions: ${totalSessions}<br>
Unique Days: ${uniqueDays}<br>
Date Range: ${dateRange}<br>
Average Sessions per Day: ${avgSessionsPerDay}<br>
Selected Lots: ${hotspotDisplay}<br>
Peak Occupancy Time: ${peakTimeStr}<br>
Max Cars: ${gaussianParams.amplitude.toFixed(1)}<br>
Standard Deviation: ${stdDevHours} hours<br>
R² Fit: ${rSquared}
                `;
            } else {
                primaryStatsDiv.innerHTML = `
Primary Dataset:<br>
Year: ${selectedYear}<br>
Total Sessions: ${totalSessions}<br>
Unique Days: ${uniqueDays}<br>
Date Range: ${dateRange}<br>
Average Sessions per Day: ${avgSessionsPerDay}<br>
Selected Lots: ${hotspotDisplay}<br>
<br>
<strong>Insufficient data for Normal Distribution</strong>
                `;
            }

            // Comparison dataset filters & data
            const comparisonHotspot = document.getElementById('comparisonHotspotFilter').value;
            let comparisonHtml = '';

            if (comparisonHotspot !== 'none') {
                const comparisonSelectedYear = Number(document.querySelector('input[name="comparisonYear"]:checked').value);
                const comparisonSelectedMonths = availableMonths.filter(month => 
                    document.getElementById(`comparisonMonth${month}`) && document.getElementById(`comparisonMonth${month}`).checked
                );
                const comparisonSelectedDays = availableDays.filter(day => 
                    document.getElementById(`comparisonDay${day}`) && document.getElementById(`comparisonDay${day}`).checked
                );

                const comparisonFilteredData = rawCsvData.filter(row => {
                    const matchesHotspot = comparisonHotspot === 'all' || row.hotspot === comparisonHotspot;
                    const matchesYear = row.date.getFullYear() === comparisonSelectedYear;
                    return comparisonSelectedMonths.includes(row.month) &&
                           comparisonSelectedDays.includes(row.dayOfWeek) &&
                           matchesHotspot &&
                           matchesYear;
                });

                const comparisonTotalSessions = comparisonFilteredData.length;
                const comparisonUniqueDays = new Set(comparisonFilteredData.map(session => session.date.toDateString())).size;
                const comparisonHotspotDisplay = comparisonHotspot === 'all' 
                    ? 'All Lots' 
                    : `${comparisonHotspot} - ${hotspotToNameMap[comparisonHotspot] || 'Unknown'}`;
                const comparisonDateRange = getDateRange(comparisonFilteredData);
                const comparisonAvgSessionsPerDay = comparisonUniqueDays > 0 
                    ? (comparisonTotalSessions / comparisonUniqueDays).toFixed(1)
                    : '0.0';

                if (comparisonGaussianParams) {
                    const cPeakHour = Math.floor(comparisonGaussianParams.mean / 60);
                    const cPeakMin = Math.round(comparisonGaussianParams.mean % 60);
                    const cPeakTimeStr = `${cPeakHour.toString().padStart(2,'0')}:${cPeakMin.toString().padStart(2,'0')}`;
                    const cStdDevHours = (comparisonGaussianParams.stdDev / 60).toFixed(1);
                    const cRSquared = calculateComparisonRSquared().toFixed(3);

                    comparisonHtml = `
Comparison Dataset:<br>
Year: ${comparisonSelectedYear}<br>
Total Sessions: ${comparisonTotalSessions}<br>
Unique Days: ${comparisonUniqueDays}<br>
Date Range: ${comparisonDateRange}<br>
Average Sessions per Day: ${comparisonAvgSessionsPerDay}<br>
Selected Lots: ${comparisonHotspotDisplay}<br>
Peak Occupancy Time: ${cPeakTimeStr}<br>
Max Cars: ${comparisonGaussianParams.amplitude.toFixed(1)}<br>
Standard Deviation: ${cStdDevHours} hours<br>
R² Fit: ${cRSquared}
                    `;
                } else {
                    comparisonHtml = `
Comparison Dataset:<br>
Year: ${comparisonSelectedYear}<br>
Total Sessions: ${comparisonTotalSessions}<br>
Unique Days: ${comparisonUniqueDays}<br>
Date Range: ${comparisonDateRange}<br>
Average Sessions per Day: ${comparisonAvgSessionsPerDay}<br>
Selected Lots: ${comparisonHotspotDisplay}<br>
<br>
<strong>Insufficient data for Normal Distribution</strong>
                    `;
                }
            }

            comparisonStatsDiv.innerHTML = comparisonHtml;
        }

        function calculateRSquared() {
            if (!gaussianParams) return 0;
            
            const businessHoursData = processedData.filter(d => d.minute >= 540 && d.minute <= 1020);
            const yActual = businessHoursData.map(d => d.normalizedCount);
            const yPredicted = businessHoursData.map(d => 
                gaussian(d.minute, gaussianParams.amplitude, gaussianParams.mean, gaussianParams.stdDev)
            );
            
            const yMean = yActual.reduce((a, b) => a + b, 0) / yActual.length;
            const ssRes = yActual.reduce((sum, y, i) => sum + Math.pow(y - yPredicted[i], 2), 0);
            const ssTot = yActual.reduce((sum, y) => sum + Math.pow(y - yMean, 2), 0);
            
            return Math.max(0, 1 - (ssRes / ssTot));
        }

        function calculateComparisonRSquared() {
            if (!comparisonGaussianParams) return 0;
            
            const businessHoursData = comparisonProcessedData.filter(d => d.minute >= 540 && d.minute <= 1020);
            const yActual = businessHoursData.map(d => d.normalizedCount);
            const yPredicted = businessHoursData.map(d => 
                gaussian(d.minute, comparisonGaussianParams.amplitude, comparisonGaussianParams.mean, comparisonGaussianParams.stdDev)
            );
            
            const yMean = yActual.reduce((a, b) => a + b, 0) / yActual.length;
            const ssRes = yActual.reduce((sum, y, i) => sum + Math.pow(y - yPredicted[i], 2), 0);
            const ssTot = yActual.reduce((sum, y) => sum + Math.pow(y - yMean, 2), 0);
            
            return Math.max(0, 1 - (ssRes / ssTot));
        }

        function getDateRange(data) {
            if (data.length === 0) return 'No data';
            const dates = data.map(row => row.date).sort((a, b) => a - b);
            const start = dates[0].toLocaleDateString();
            const end = dates[dates.length - 1].toLocaleDateString();
            return start === end ? start : `${start} to ${end}`;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.getElementById('controls'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function exportCSV() {
            if (!processedData || processedData.length === 0) {
                alert('No data to export');
                return;
            }

            let header, rows;

            if (comparisonProcessedData.length > 0) {
                header = ['Time', 'Primary - Average Cars Parked', 'Comparison - Average Cars Parked'];
                rows = processedData.map((d, i) => [
                    d.time, 
                    d.normalizedCount.toFixed(2),
                    comparisonProcessedData[i] ? comparisonProcessedData[i].normalizedCount.toFixed(2) : '0.00'
                ]);
            } else {
                header = ['Time', 'Average Cars Parked'];
                rows = processedData.map(d => [d.time, d.normalizedCount.toFixed(2)]);
            }

            const csvContent = [header, ...rows].map(e => e.join(",")).join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'parking_data.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportPNG() {
            if (!chart) {
                alert('No chart to export');
                return;
            }

            const a = document.createElement('a');
            a.href = chart.toBase64Image();
            a.download = 'parking_chart.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function initChart() {
            const ctx = document.getElementById('parkingChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Primary - Average Cars Parked',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            pointRadius: 1,
                            pointHoverRadius: 4,
                            tension: 0.1
                        },
                        {
                            label: 'Primary - Normal Distribution',
                            data: [],
                            borderColor: '#FF5722',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Comparison - Average Cars Parked',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            pointRadius: 1,
                            pointHoverRadius: 4,
                            tension: 0.1,
                            hidden: true
                        },
                        {
                            label: 'Comparison - Normal Distribution',
                            data: [],
                            borderColor: '#E91E63',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            tension: 0.4,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Parking Occupancy Analysis from CSV Data',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time of Day'
                            },
                            ticks: {
                                maxTicksLimit: 24,
                                callback: function(value, index) {
                                    const time = this.getLabelForValue(value);
                                    const [hour, minute] = time.split(':');
                                    return minute === '00' ? time : '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Average Cars Parked per Day'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 1
                            }
                        }
                    }
                }
            });
        }

        window.addEventListener('load', () => {
            setupFileUpload();
        });
    </script>
</body>
</html>

